sap.ui.define(["feedbackapp/feedbackapp/controller/BaseController","sap/ui/model/json/JSONModel","feedbackapp/feedbackapp/model/models","sap/m/MessageToast","sap/m/library","sap/ui/core/Fragment","sap/ui/core/format/DateFormat","sap/ui/model/Filter","sap/ui/model/FilterOperator","feedbackapp/feedbackapp/utils/FeedbackAppUtilityFile","sap/m/MessageBox"],function(e,t,o,a,i,s,l,r,n,d,c){"use strict";return e.extend("feedbackapp.feedbackapp.controller.Main",{onInit:function(){},onAfterRendering:function(){this.onLoadReviewList();this.setEmployeeModel()},getUserInfo:function(){const e=this.getBaseURL()+"/user-api/currentUser";var t=this.getView().getModel("SettingsModel");var o={firstname:"Dummy",lastname:"User",email:"dummy.user@com",name:"dummy.user@com",displayName:"Dummy User (dummy.user@com)"};t.loadData(e);t.dataLoaded().then(()=>{if(!t.getData().email){t.setProperty("/LoggedInInfo","userInfo")}}).catch(()=>{t.setData(o);t.setProperty("/LoggedInInfo","userInfo")});console.log(t)},getBaseURL:function(){var e=this.getOwnerComponent().getManifestEntry("/sap.app/id");var t=e.replaceAll(".","/");var o=jQuery.sap.getModulePath(t);return o},onListDeleteOptions:function(e){var t=this.getView().getModel("FeedbackModel");var o=e.getSource().getBindingContext("FeedbackModel").getObject();var a=this.getView().getModel("SettingsModel").getProperty("/ReviewsListSelectedKey");if(a==="Feedback"){c.warning("This will archive the Feedback Report and all associated Child Reviews.",{actions:[c.Action.OK,c.Action.CANCEL],title:"Archiving Feedback Report and Review Entries",onClose:function(e){if(e===c.Action.OK){d.deleteFeedbackReport(this,o)}}.bind(this)})}else if(a==="Reviews"){c.warning("This will Archive the Review Entry",{actions:[c.Action.OK,c.Action.CANCEL],title:"Review Entry",onClose:function(e){if(e===c.Action.OK){d.deleteReviewSingular(this,o)}}.bind(this)})}},onLoadReviewList:function(){var e=this.getView().getModel("FeedbackModel");var t=this.getView().getModel("SettingsModel");var o=this.getView().getModel("PDPlanModel");var a=this.getView().getModel("SettingsModel").getProperty("/ReviewsListSelectedKey");this.loadFromBackend("/ReviewList",e,a);d.getMSGraphEmployees(this);var i="PDplans";this.loadFromBackend("/PDplansList",o,i);if(a==="Feedback"){this.loadFromBackend("/Reviews",e,"IndividualReviews");this.setEmpFilterSelectList()}else if(a==="Reviews"){this.setEmpFilterSelectList()}else{this.onLoadPDplanList()}this.loadFromBackend("/UserRole",t,"Roles");this.getView().getModel("oDataFeedback").read("/Roles",{success:function(e,o){try{var a=e.results[0].UserRole}catch(e){var a="User"}t.setProperty("/UserRole",a)}})},onLoadPDplanList:function(){var e=this.getView().getModel("PDPlanModel");this.getPDPlanFromBackend("ShowAll","/PDplansList","PDplans",null)},setEmpFilterSelectList:function(){var e=this.getView().getModel("SettingsModel");var t=this.getView().getModel("FeedbackModel").getProperty("/Feedback");var o=[];for(var a=0;a<t.length;a++){var i={FeedbackID:t[a].FeedbackID};o.push(i)}e.setProperty("/EmployeeFilteredSelectList",o)},setEmployeeModel:function(){d.getMSGraphEmployees(this)},onselectPDplanListItem:function(e){var t=e.getSource().getBindingContext("PDPlanModel").getObject();var o=this.getView().getModel("PDPlanModel");this.getView().getModel("SettingsModel").setProperty("/EmployeeName",t.EmployeeID);var a=sap.ui.core.UIComponent.getRouterFor(this);this.loadFromBackend("/Goals",o,"Goals");a.navTo("PDPlanDetails");o.setProperty("/NotesPDPlan",t);console.log(t)},onReviewListItemSelected:function(e){var t=this.getView().getModel("FeedbackModel");var o=this.getView().getModel("SettingsModel");var a=sap.ui.core.UIComponent.getRouterFor(this);var i=e.getSource().getBindingContext("FeedbackModel").getObject();var s=this.getView().getModel("EmployeeNamesModel").getProperty("/Employee");var l=o.getProperty("/ReviewsListSelectedKey");var c,g;d.parseFloats(i);if(l==="Feedback"){c=s.findIndex(e=>e.Displayname==i.EmployeeName);o.setProperty("/RoleName",s[c].Jobtitle);console.log(o.getProperty("/RoleName"));o.setProperty("/EmployeeName",s[c].Displayname);t.setProperty("/ReviewDetails/",i);var p=[];var m=new r({path:"FeedbackID",operator:n.EQ,value1:t.getProperty("/ReviewDetails").FeedbackID});p.push(m);var v=new r({path:"ReviewState",operator:n.EQ,value1:"Completed"});p.push(v);this.getView().getModel("oDataFeedback").read("/IndividualReviews",{filters:p,success:function(e,o){var i=e.results;t.setProperty("/ReviewStorage",i);console.log(t.getProperty("/ReviewStorage"));a.navTo("ReviewDetail")}});this.loadFromBackend("/Goals",t,"Goals")}else if(l==="Reviews"){c=s.findIndex(e=>e.Displayname==i.EmployeeName);g=s.findIndex(e=>e.Displayname==i.ReviewerName);console.log(s[c]);o.setProperty("/EmployeeName",s[c].Displayname);o.setProperty("/ReviewerName",s[g].Displayname);t.setProperty("/ReviewDetails/",i);o.setProperty("/EmployeeName",s[c].Displayname);a.navTo("ReviewDetail")}else if(l==="PDplans"){o.setProperty("/EmployeeSelected",true);a.navTo("PDPlanDetails")}},onSelectEmployee:function(e){var t=e.getSource().getBindingContext("EmployeeNamesModel").getObject();this.getView().getModel("SettingsModel").setProperty("/EmployeeName",t.Displayname);this.getView().getModel("SettingsModel").setProperty("/RoleName",t.Jobtitle);var o=sap.ui.core.UIComponent.getRouterFor(this);o.navTo("PDPlanDetails")},onNameOrDateChange:function(e){var t=this.getView().getModel("SettingsModel").getProperty("/ReviewsListSelectedKey");var o=e.getSource().getBindingContext("FeedbackModel").getObject();var i=this.getView().getModel("FeedbackModel");var s=i.getProperty("/Feedback");var l,r,n;if(t==="Feedback"){l="Feedback";r="Feedback";n=o.FeedbackID;o.ReviewerName="Admin";o=d.stringifyScores(this,o)}else{l="Reviews";r="Review";n=o.ReviewID;o.FeedbackID=parseInt(e.getSource().getBindingContext("FeedbackModel").getObject().FeedbackID);for(var c=0;c<s.length;c++){if(s[c].FeedbackID===o.FeedbackID){o.EmployeeName=s[c].EmployeeName}}}this.getView().getModel("oDataFeedback").update("/"+l+"("+r+"ID="+n+")",o,{success:function(e,t){a.show("Change Successful!")},error:function(e){a.show("Error trying to update!")}})},onGoalEdit:function(e){this.getView().getModel("SettingsModel").setProperty("/EnableGoalForm",true);var t=e.getSource().getBindingContext("FeedbackModel").getObject();this.getView().getModel("FeedbackModel").setProperty("/Goal",t)},onGoalSave:function(e){d.updateGoal(this);this.getView().getModel("SettingsModel").setProperty("/EnableGoalForm",false);this.getView().getModel("FeedbackModel").setProperty("/Goal",o.createGoalTemplate())},onGoalCancel:function(e){this.getView().getModel("SettingsModel").setProperty("/EnableGoalForm",false);this.getView().getModel("FeedbackModel").setProperty("/Goal",o.createGoalTemplate())},onGoalEnableButtons:function(e){this.getView().getModel("SettingsModel").setProperty("/IsEditingGoal",true)}})});